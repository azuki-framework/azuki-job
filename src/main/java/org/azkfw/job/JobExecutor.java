/** * Licensed to the Apache Software Foundation (ASF) under one * or more contributor license agreements.  See the NOTICE file * distributed with this work for additional information * regarding copyright ownership.  The ASF licenses this file * to you under the Apache License, Version 2.0 (the * "License"); you may not use this file except in compliance * with the License.  You may obtain a copy of the License at * *     http://www.apache.org/licenses/LICENSE-2.0 * * Unless required by applicable law or agreed to in writing, software * distributed under the License is distributed on an "AS IS" BASIS, * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. * See the License for the specific language governing permissions and * limitations under the License. */package org.azkfw.job;import java.io.IOException;import java.io.InputStream;import org.azkfw.configuration.ConfigurationFormatException;import org.azkfw.context.Context;import org.azkfw.context.ContextSupport;import org.azkfw.job.commandline.CommandLineArgument;import org.azkfw.job.commandline.CommandLineArgumentPurser;import org.azkfw.job.commandline.StandardCommandLineArgumentPurser;import org.azkfw.job.context.JobContext;import org.azkfw.job.job.Job;import org.azkfw.job.parameter.Parameter;import org.azkfw.job.store.JobSessionStore;import org.azkfw.log.LoggerFactory;import org.azkfw.persistence.proterty.Property;import org.azkfw.persistence.proterty.PropertyFile;import org.azkfw.persistence.proterty.PropertyManager;import org.azkfw.persistence.proterty.PropertySupport;import org.azkfw.persistence.session.SessionSupport;import org.azkfw.plugin.PluginManager;import org.azkfw.plugin.PluginServiceException;import org.azkfw.util.StringUtility;/** * このクラスは、ジョブの実行を行うクラスです。 *  * @since 1.0.0 * @version 1.0.0 2013/07/19 * @author Kawakicchi *  */public class JobExecutor {	/**	 * メイン関数	 * 	 * @param args 引数	 */	public static void main(final String[] args) {		CommandLineArgumentPurser purser = new StandardCommandLineArgumentPurser();		CommandLineArgument arg = purser.purse(args);		JobExecutor executor = new JobExecutor();		executor.setJobClass(arg.getOptionValue("jobClass"));		executor.setBaseDir(arg.getOptionValue("baseDir"));		executor.setPluginConfig(arg.getOptionValue("pluginConfig"));		executor.setLog(arg.getOptionValue("logClass"), arg.getOptionValue("logConfig"));		executor.run();	}	private String jobClass;	private String baseDir;	private String pluginConfig;	private String logClass;	private String logConfig;	public final void setJobClass(final String aClass) {		jobClass = aClass;	}	public final void setBaseDir(final String aDir) {		baseDir = aDir;	}	public final void setPluginConfig(final String aConfig) {		pluginConfig = aConfig;	}	public final void setLog(final String aClass, final String aConfig) {		logClass = aClass;		logConfig = aConfig;	}	public JobExecutor() {	}	@SuppressWarnings("unchecked")	public void run() {		Context context = null;		if (StringUtility.isNotEmpty(baseDir)) {			context = new JobContext(baseDir);		} else {			context = new JobContext();		}		// Load log		LoggerFactory.load(logClass, logConfig, context);		// Load job		Class<? extends Job> jobClazz = null;		Job job = null;		try {			jobClazz = (Class<? extends Job>) Class.forName(jobClass);			job = jobClazz.newInstance();		} catch (ClassNotFoundException ex) {			ex.printStackTrace();			return;		} catch (IllegalAccessException ex) {			ex.printStackTrace();			return;		} catch (InstantiationException ex) {			ex.printStackTrace();			return;		}		// Load plugin		try {			if (StringUtility.isNotEmpty(pluginConfig)) {				InputStream stream = context.getResourceAsStream(pluginConfig);				if (null != stream) {					PluginManager.initialize();					PluginManager.load(stream, context);				}			}		} catch (ConfigurationFormatException ex) {			ex.printStackTrace();			return;		} catch (PluginServiceException ex) {			ex.printStackTrace();			return;		} catch (IOException ex) {			ex.printStackTrace();			return;		}		try {			Property property = null;			PropertyFile propertyFile = jobClazz.getAnnotation(PropertyFile.class);			if (null != propertyFile) {				String value = propertyFile.value();				if (StringUtility.isNotEmpty(value)) {					property = PropertyManager.get(jobClazz);					if (null == property) {						property = PropertyManager.load(jobClazz, context);					}				}			}			if (job instanceof SessionSupport) {				((SessionSupport) job).setSession(new JobSessionStore());			}			if (job instanceof ContextSupport) {				((ContextSupport) job).setContext(context);			}			if (job instanceof PropertySupport) {				if (null != property) {					((PropertySupport) job).setProperty(property);				} else {					System.out.println("This job is not property file.[" + job.getClass().getName() + "]");				}			} else {				if (null != property) {					System.out.println("This job is not property support.[" + job.getClass().getName() + "]");				}			}			job.initialize();			job.execute(new Parameter());		} catch (JobServiceException ex) {			ex.printStackTrace();		} finally {			job.destroy();			PluginManager.destroy();		}	}}